pipeline {
    agent any
    options {
        skipStagesAfterUnstable()
    }
    stages {
        
          /*stage('test') {
      steps {
        dir('frontend') {
          bat 'npm run test'
        }
      }
     }*/
        
        stage('DAST') {
            steps {
                script {
                    try {
                        echo "Inicio de Scanneo Dinamico"
                        bat "docker exec awesome_antonelli zap-cli --verbose quick-scan http://opencart.abstracta.us -l Medium" 
                        //sh "docker exec zap zap-cli --verbose alerts --alert-level Medium -f json | jq length"
                        currentBuild.result = 'SUCCESS' 
                    }
                    catch (Exception e) {
                            //echo e.getMessage() 
                            //currentBuild.result = 'FAILURE'
                            println ("Revisar Reporte ZAP. Se encontraron Vulnerabilidades.")

                        }
                    }  
                    echo currentBuild.result 
                    echo "Generacion de Reporte"
                    bat "docker exec awesome_antonelli zap-cli --verbose report -o 'C:/ProgramData/Jenkins/.jenkins/workspace/Test/frontend/owasp-quick-scan-report.html' --output-format html"
                    publishHTML target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: false,
                        keepAll: true,
                        reportDir: 'C:/ProgramData/Jenkins/.jenkins/workspace/Test/frontend',
                        reportFiles: 'owasp-quick-scan-report.html',
                        reportName: 'Analisis DAST'
                      ]          
            }
        }
    }
}