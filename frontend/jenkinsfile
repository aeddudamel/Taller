pipeline {
  agent any

  tools {
    nodejs "node"
  }

  stages {
    stage('install') {
      steps {
        git branch: 'main', url: 'https://github.com/aeddudamel/Taller.git'
        dir('frontend') {
          bat 'npm install'
        }
      }
    }

    stage('test') {
      steps {
        dir('frontend') {
          bat 'npm run test'
        }
      }
    }
        stage('DAST') {
            steps { 
              dir('frontend') {
                script {
                    try {
                        echo "Inicio de Scanneo Dinamico"
                        bat "docker exec zap zap-cli --verbose quick-scan http://pipeline.ironbox.com.ar:8090 -l Medium" 
                        //sh "docker exec zap zap-cli --verbose alerts --alert-level Medium -f json | jq length"
                        currentBuild.result = 'SUCCESS' 
                    }
                    catch (Exception e) {
                            //echo e.getMessage() 
                            //currentBuild.result = 'FAILURE'
                            println ("Revisar Reporte ZAP. Se encontraron Vulnerabilidades.")

                        }
                    } }   
                    echo currentBuild.result 
                    echo "Generacion de Reporte"
                    sh "docker exec zap zap-cli --verbose report -o /reports/owasp-quick-scan-report.html --output-format html"
                    publishHTML target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: false,
                        keepAll: true,
                        reportDir: '/opt/dast/reports',
                        reportFiles: 'owasp-quick-scan-report.html',
                        reportName: 'Analisis DAST'
                      ]          
            }
        }
    



  }

}
